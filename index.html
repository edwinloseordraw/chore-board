<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chore Board</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.webmanifest" />
  
  <style>
    :root{
      --bg:#111;
      --panel:#171717;
      --panel2:#1f1f1f;
      --panel3:#121212;
      --border:#2a2a2a;
      --border2:#222;
      --text:#f5f5f5;
      --muted: rgba(245,245,245,0.75);
      --muted2: rgba(245,245,245,0.6);
      --btn:#2a2a2a;
      --btnActive:#4caf50;
      --danger:#c62828;
      --radius: 10px;
    }

    .assignSelect{
      width: 130px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.45);
      color: #fff;
      font-size: 13px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      gap:8px;
      padding:10px;
      background:#1a1a1a;
      flex-wrap:wrap;
      align-items:center;
      position:sticky;
      top:0;
      z-index:5;
    }

    header button{
      background:var(--btn);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
    }

    header button.active{
      background:var(--btnActive);
      color:#000;
      font-weight:700;
    }

    header .spacer{ flex:1; }

    header .danger{ background:var(--danger); }

    main{
      flex:1;
      padding:10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
.maintForm{
  display:grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap:12px;
  align-items:end;
}
.maintForm .field label{
  display:block;
  font-size:12px;
  opacity:.8;
  margin-bottom:6px;
}
.maintForm input, .maintForm select{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  color:var(--text);
}
.maintForm .actions button{
  width:100%;
}

.maintList{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.maintRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.18);
}
.maintTask{
  font-weight:700;
}
.maintSub{
  margin-top:4px;
  font-size:12px;
  opacity:.8;
}

@media (max-width: 980px){
  .maintForm{ grid-template-columns: 1fr; }
}

    /* ---------- Common panels ---------- */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:10px;
    }

    .panel h2, .panel h3{
      margin:0 0 8px 0;
      font-size:14px;
      letter-spacing:0.2px;
      opacity:0.95;
    }

    .hint{
      font-size:12px;
      color:var(--muted2);
      margin-top:-4px;
      margin-bottom:8px;
      line-height:1.25;
    }

    /* ---------- Dashboard ---------- */
    .dashGrid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:10px;
      min-height:0;
    }

    .rings{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
	}

    .ringCard{
      background:var(--panel2);
      border:1px solid var(--border2);
      border-radius:var(--radius);
      padding:10px;
      flex:1 1 220px;
      min-width:220px;
      display:flex;
      gap:12px;
      align-items:center;
    }

    .ringMeta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:110px;
    }

    .ringMeta .title{
      font-weight:700;
      font-size:14px;
      letter-spacing:0.2px;
    }

    .ringMeta .sub{
      font-size:12px;
      color:var(--muted2);
      line-height:1.2;
    }

    .ringSvgWrap{
      width:76px;
      height:76px;
      position:relative;
      flex:0 0 auto;
    }

    .ringSvgWrap .pct{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      font-weight:800;
      letter-spacing:0.2px;
    }

    svg{ display:block; }

    /* a slightly "chalky" look without getting fancy */
    .chalkTrack{ opacity:0.25; }
    .chalkStroke{
      filter: drop-shadow(0 0 0.6px rgba(255,255,255,0.2));
    }

    .dashNav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .dashNav button{
      padding:10px 12px;
      border-radius:10px;
    }

    .notesBox{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .notesControls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .notesControls input{
      background:var(--panel3);
      border:1px solid #333;
      color:#fff;
      border-radius:8px;
      padding:8px 10px;
      font-size:14px;
      width:180px;
    }

    .notesControls .small{
      font-size:12px;
      color:var(--muted2);
    }

    textarea{
      width:100%;
      min-height:180px;
      background:var(--panel3);
      color:#fff;
      border:1px solid #333;
      border-radius:10px;
      padding:10px;
      resize:vertical;
      font-size:14px;
      line-height:1.25;
    }

    .lockedOverlay{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      background:rgba(0,0,0,0.35);
      border:1px dashed rgba(255,255,255,0.25);
      border-radius:10px;
      padding:10px;
      color:var(--muted);
      font-size:13px;
    }

    /* ---------- Day view ---------- */
    .columns{
      flex:1;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      overflow:hidden;
      min-height:0;
    }

    .column{
      background:var(--panel2);
      border:1px solid var(--border2);
      border-radius:var(--radius);
      padding:10px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .column h2{
      margin:0 0 8px 0;
      text-align:center;
      font-size:16px;
      font-weight:800;
    }

    .chore{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
      font-size:14px;
    }

    /* Weekly chores panel (Phase 3), moved BELOW columns per your request */
    .weeklyGrid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px 10px;
    }

    .weeklyItem{
      display:grid;
      grid-template-columns:18px 1fr 120px;
      align-items:center;
      gap:8px;
      background:var(--panel3);
      border:1px solid var(--border2);
      border-radius:10px;
      padding:8px;
      min-height:44px;
    }

    .weeklyItem .label{
      font-size:13px;
      opacity:0.95;
      line-height:1.15;
      word-break:break-word;
    }

    .weeklyItem select{
      background:#0f0f0f;
      color:#fff;
      border:1px solid #333;
      border-radius:8px;
      padding:6px 8px;
      font-size:13px;
      width:120px;
    }

    /* Yesterday summary */
    .yesterdayGrid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }

    .yCard{
      background:var(--panel3);
      border:1px solid var(--border2);
      border-radius:10px;
      padding:8px;
      min-height:48px;
    }

    .yTitle{
      font-weight:800;
      font-size:13px;
      text-align:center;
      margin-bottom:6px;
      opacity:0.95;
    }

    .yLine{
      font-size:12.5px;
      opacity:0.9;
      margin:4px 0;
      line-height:1.2;
      word-break:break-word;
    }

    .notesDay textarea{
      min-height:80px;
    }

    /* ---------- Simple list pages (biweekly/monthly/maintenance scaffolding) ---------- */
    .listGrid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    .listItem{
      background:var(--panel2);
      border:1px solid var(--border2);
      border-radius:10px;
      padding:10px;
      display:flex;
      align-items:center;
      gap:10px;
      min-height:48px;
    }
    .listItem .name{
      flex:1;
      font-size:14px;
      opacity:0.95;
    }
    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .toolbar .left{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .toolbar .right{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .toolbar button{
      background:var(--btn);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
    }
    .toolbar button.danger{ background:var(--danger); }

    /* ghost buttons (used in Maintenance rows) */
    button.ghost{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }
    button.ghost:hover{
      background: rgba(255,255,255,0.06);
    }

    /* responsive */
    @media (max-width: 980px){
      .dashGrid{ grid-template-columns:1fr; }
      .columns{ grid-template-columns:1fr 1fr; }
      .yesterdayGrid{ grid-template-columns:1fr 1fr; }
      .weeklyGrid{ grid-template-columns:1fr; }
      .listGrid{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<header id="topNav"></header>
<main id="app"></main>

<script>
/* =========================
   ROUTES + CONSTANTS
========================= */

const DAYS = ["lunes","martes","miercoles","jueves","viernes","sabado","domingo"];
const PEOPLE = ["Dad","Mom","Ethan","Celo"];

function todayKey(){
  const map = ["domingo","lunes","martes","miercoles","jueves","viernes","sabado"];
  return map[new Date().getDay()];
}

function prevDayKey(dayKey){
  const idx = DAYS.indexOf(dayKey);
  if (idx === -1) return "domingo";
  return DAYS[(idx - 1 + DAYS.length) % DAYS.length];
}

/* =========================
   DATA (still placeholders)
   - We'll replace DAILY_CHORES & WEEKLY_CHORES with your real lists later.
   - Bi-weekly/monthly/maintenance lists stay mostly empty until Phase 5-7.
========================= */

const DAILY_CHORES = {
  Dad: ["Dog poop","Trash"],
  Mom: ["Laundry","Kitchen"],
  Ethan: ["Room","Homework"],
  Celo: ["Dishes","Toys"]
};

const WEEKLY_CHORES = [
  "Sweep backyard",
  "Wipe inside fridge",
  "Clean inside microwave",
  "Clean trash can (inside & out)",
  "Clean toilets",
  "Dust ceiling fans & vents",
  "Wipe down bathroom",
  "Doors & windows"
];

// Phase 5/6 scaffolding
const BIWEEKLY_CHORES = [
  "Sweep the outside area",
  "Wipe cabinet fronts & handles",
  "Clean pet bedding (if applicable)",
  "Wipe window sills & tracks",
  "Wipe walls & doors",
  "Clean windows (inside)"
];

const MONTHLY_CHORES = ["Clean baseboards",
  "Clean light switches & door handles",
  "Deep clean bathrooms (grout, tub edges, behind toilet)",
  "Clean behind large appliances (fridge, stove if movable)",
  "Wash blankets & throws",
  "Wash mattress protectors",
  "Clean oven (light or self-clean)",
  "Clean front door",
  "Spot clean patio or porch"];    // Phase 6

/* =========================
   STORAGE HELPERS
========================= */

function jget(k, fallback){
  try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); }
  catch{ return fallback; }
}
function jset(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

// Daily state (per day)
function loadDailyState(){ return jget("dailyState", {}); }
function saveDailyState(s){ jset("dailyState", s); }

// Weekly shared state
function loadWeeklyState(){ return jget("weeklyState", { checks:{}, assign:{} }); }
function saveWeeklyState(s){ jset("weeklyState", s); }

// Biweekly shared state (Phase 5)
function loadBiweeklyState(){ return jget("biweeklyState", { checks:{}, assign:{} }); }
function saveBiweeklyState(s){ jset("biweeklyState", s); }

// Monthly shared state (Phase 6)
function loadMonthlyState(){ return jget("monthlyState", { checks:{}, assign:{} }); }
function saveMonthlyState(s){ jset("monthlyState", s); }

// Maintenance log (Phase 7)
function loadMaintState(){ return jget("maintState", { entries:[] }); }
function saveMaintState(s){ jset("maintState", s); }

// Dashboard notes + pin
function loadDashState(){ return jget("dashState", { pinHash:null, notes:"" }); }
function saveDashState(s){ jset("dashState", s); }

/* =========================
   PIN (SHA-256 hash)
   - Not "bank security", just enough to stop kids from mashing notes.
========================= */

function bufToHex(buffer){
  const bytes = new Uint8Array(buffer);
  return Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function sha256Hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return bufToHex(hash);
}

/* =========================
   NAV + ROUTING
========================= */

function route(){
  // Normalize: supports "#/dashboard", "#dashboard", "#//dashboard", etc.
  const raw = (location.hash || "")
    .replace(/^#/, "")     // remove leading "#"
    .replace(/^\/+/, "")   // remove one or more leading "/"
    .trim();

  return raw || "dashboard";
}

function goto(path){
  location.hash = "#/" + path;
}

function renderTopNav(){
  const nav = document.getElementById("topNav");
  nav.innerHTML = "";

  const r = route();

  // Left: Dashboard + Hoy
  const btnDash = document.createElement("button");
  btnDash.textContent = "Dashboard";
  if (r === "dashboard") btnDash.classList.add("active");
  btnDash.onclick = () => goto("dashboard");
  nav.appendChild(btnDash);

  const btnHoy = document.createElement("button");
  btnHoy.textContent = "Hoy";
  if (DAYS.includes(r) && r === todayKey()) btnHoy.classList.add("active");
  btnHoy.onclick = () => goto(todayKey());
  nav.appendChild(btnHoy);

  // Day quick buttons (small but usable)
  DAYS.forEach(d => {
    const b = document.createElement("button");
    b.textContent = d;
    if (r === d) b.classList.add("active");
    b.onclick = () => goto(d);
    nav.appendChild(b);
  });

  const spacer = document.createElement("div");
  spacer.className = "spacer";
  nav.appendChild(spacer);

  // Right: other sections
  const b1 = document.createElement("button");
  b1.textContent = "Bi-weekly";
  if (r === "biweekly") b1.classList.add("active");
  b1.onclick = () => goto("biweekly");
  nav.appendChild(b1);

  const b2 = document.createElement("button");
  b2.textContent = "Monthly";
  if (r === "monthly") b2.classList.add("active");
  b2.onclick = () => goto("monthly");
  nav.appendChild(b2);

  const b3 = document.createElement("button");
  b3.textContent = "Maintenance";
  if (r === "maintenance") b3.classList.add("active");
  b3.onclick = () => goto("maintenance");
  nav.appendChild(b3);
}

window.addEventListener("hashchange", renderApp);

/* =========================
   RING CALCULATIONS
========================= */

function calcDailyProgress(){
  const day = todayKey();
  const s = loadDailyState();
  const dayObj = s[day] || { checks:{} };

  // total daily checkboxes (all people)
  let total = 0;
  for (const person of PEOPLE){
    total += (DAILY_CHORES[person] || []).length;
  }

  // done today
  let done = 0;
  for (const person of PEOPLE){
    for (const chore of (DAILY_CHORES[person] || [])){
      const key = `${person}::${chore}`;
      if (dayObj.checks && dayObj.checks[key]) done++;
    }
  }

  return { done, total };
}

/**
 * Semanal ring rule:
 * Weekly chore counts as done ONLY when:
 *  - assigned to someone AND
 *  - checked complete
 */
  
function calcWeeklyProgress(){
  const total = WEEKLY_CHORES.length;
  const w = loadWeeklyState();

  const done = WEEKLY_CHORES.reduce((acc, c) => {
    const checked  = w.checks && w.checks;
    const assigned = w.assign && w.assign;
    return acc + (checked && assigned ? 1 : 0);
  }, 0);

  return { done, total };
}

function calcBiweeklyProgress(){
  const total = BIWEEKLY_CHORES.length;
  const b = loadBiweeklyState();

  const done = BIWEEKLY_CHORES.reduce((acc, c) => {
    const checked  = b.checks && b.checks;
    const assigned = b.assign && b.assign;
    return acc + (checked && assigned ? 1 : 0);
  }, 0);

  return { done, total };
}

function calcMonthlyProgress(){
  const total = MONTHLY_CHORES.length;
  const m = loadMonthlyState();

  const done = MONTHLY_CHORES.reduce((acc, c) => {
    const checked  = m.checks && m.checks;
    const assigned = m.assign && m.assign;
    return acc + (checked && assigned ? 1 : 0);
  }, 0);

  return { done, total };
}

function pct(done, total){
  if (!total) return 0;
  return Math.round((done / total) * 100);
}
/* =========================
   DASHBOARD RENDER
========================= */

function renderDashboard(){
  const app = document.getElementById("app");

  const w = calcWeeklyProgress();
  const b = calcBiweeklyProgress();
  const m = calcMonthlyProgress();
  const d = calcDailyProgress();

  const wp = pct(w.done, w.total);
  const bp = pct(b.done, b.total);
  const mp = pct(m.done, m.total);
  const dp = pct(d.done, d.total);

  const dash = loadDashState();
  const locked = !!dash.pinHash;

  app.innerHTML = `
    <div class="dashGrid">
      <div class="panel">
        <h2>Progress Dashboard</h2>
        <div class="hint">Rings track completion for Semanal, Bi-weekly, and Monthly. (Maintenance not included yet.)</div>

        <div class="rings">
          ${ringCard("Daily (Hoy)", d.done, d.total, dp)}
          ${ringCard("Semanal", w.done, w.total, wp)}
          ${ringCard("Bi-weekly", b.done, b.total, bp)}
          ${ringCard("Monthly", m.done, m.total, mp)}
        </div>

        <div class="dashNav">
          <button onclick="goto('${todayKey()}')">Go to Hoy</button>
          <button onclick="goto('biweekly')">Bi-weekly</button>
          <button onclick="goto('monthly')">Monthly</button>
          <button onclick="goto('maintenance')">Maintenance</button>
        </div>
      </div>

      <div class="panel notesBox">
        <h2>Dashboard Notes (PIN locked)</h2>
        <div class="hint">Lives only here. Not affected by weekly reset. Keep it simple and useful.</div>

        <div class="notesControls" id="pinControls"></div>

        <div id="notesArea"></div>
      </div>
    </div>
  `;

  // Render notes area based on lock state
  renderPinControlsAndNotes();
}
function ringSVG(percent){
  const r = 30;                 // radius
  const cx = 38, cy = 38;       // center
  const c = 2 * Math.PI * r;    // circumference

  // clamp 0-100
  const p = Math.max(0, Math.min(100, Number(percent) || 0));
  const dash = (p / 100) * c;

  return `
    <svg width="76" height="76" viewBox="0 0 76 76" aria-hidden="true">
      <circle class="chalkTrack" cx="${cx}" cy="${cy}" r="${r}"
        stroke="rgba(255,255,255,0.55)" stroke-width="10" fill="none" />
      <circle class="chalkStroke" cx="${cx}" cy="${cy}" r="${r}"
        stroke="rgba(255,255,255,0.95)" stroke-width="10" fill="none"
        stroke-linecap="round"
        stroke-dasharray="${dash} ${c - dash}"
        transform="rotate(-90 ${cx} ${cy})" />
    </svg>
  `;
}
function ringCard(title, done, total, percent, extraHint){
  const sub = total ? `${done}/${total} complete` : `0/0 (set up later)`;
  const hint = extraHint ? `<div class="sub">${extraHint}</div>` : "";
  return `
    <div class="ringCard">
      <div class="ringSvgWrap">
        ${ringSVG(percent)}
        <div class="pct">${percent}%</div>
      </div>
      <div class="ringMeta">
        <div class="title">${title}</div>
        ${hint}
        <div class="sub">${sub}</div>
      </div>
    </div>
  `;
}

function renderPinControlsAndNotes(){
  const dash = loadDashState();
  const controls = document.getElementById("pinControls");
  const area = document.getElementById("notesArea");

  if (!dash.pinHash){
    controls.innerHTML = `
      <input id="pinSet" type="password" inputmode="numeric" placeholder="Set new PIN" />
      <button id="btnSetPin">Set PIN</button>
      <div class="small">Optional. If you set a PIN, editing requires it.</div>
    `;
    area.innerHTML = `
      <textarea id="dashNotes" placeholder="Write dashboard notes...">${escapeHtml(dash.notes || "")}</textarea>
    `;

    document.getElementById("btnSetPin").onclick = async () => {
      const pin = (document.getElementById("pinSet").value || "").trim();
      if (pin.length < 4) { alert("PIN must be at least 4 digits."); return; }
      dash.pinHash = await sha256Hex(pin);
      saveDashState(dash);
      // lock immediately
      dashSessionLock(true);
      renderPinControlsAndNotes();
    };

    document.getElementById("dashNotes").oninput = () => {
      const d = loadDashState();
      d.notes = document.getElementById("dashNotes").value;
      saveDashState(d);
    };

    return;
  }

  const unlocked = dashSessionUnlocked();

  if (!unlocked){
    controls.innerHTML = `
      <input id="pinEnter" type="password" inputmode="numeric" placeholder="Enter PIN" />
      <button id="btnUnlock">Unlock</button>
      <button id="btnChangePin">Change PIN</button>
      <div class="small">Notes are locked. Kids can't edit unless they guess your PIN (good luck).</div>
    `;

    area.innerHTML = `
      <div class="lockedOverlay">
        <div>ðŸ”’ Notes locked. Unlock to edit.</div>
        <div style="opacity:0.8;">(Content is still visible.)</div>
      </div>
      <textarea id="dashNotes" readonly>${escapeHtml(dash.notes || "")}</textarea>
    `;

    document.getElementById("btnUnlock").onclick = async () => {
      const pin = (document.getElementById("pinEnter").value || "").trim();
      const h = await sha256Hex(pin);
      const d = loadDashState();
      if (h !== d.pinHash){ alert("Wrong PIN."); return; }
      dashSessionLock(false);
      renderPinControlsAndNotes();
    };

    document.getElementById("btnChangePin").onclick = async () => {
      const oldPin = prompt("Enter current PIN:");
      if (oldPin === null) return;
      const oldHash = await sha256Hex(oldPin.trim());
      const d = loadDashState();
      if (oldHash !== d.pinHash){ alert("Wrong PIN."); return; }
      const newPin = prompt("Enter new PIN (min 4 digits):");
      if (newPin === null) return;
      if (newPin.trim().length < 4){ alert("PIN must be at least 4 digits."); return; }
      d.pinHash = await sha256Hex(newPin.trim());
      saveDashState(d);
      dashSessionLock(true); // lock after change
      renderPinControlsAndNotes();
    };

    return;
  }

  // unlocked
  controls.innerHTML = `
    <button id="btnLock">Lock</button>
    <button id="btnClearPin">Remove PIN</button>
    <div class="small">Unlocked for this session only.</div>
  `;

  area.innerHTML = `
    <textarea id="dashNotes" placeholder="Write dashboard notes...">${escapeHtml(dash.notes || "")}</textarea>
  `;

  document.getElementById("dashNotes").oninput = () => {
    const d = loadDashState();
    d.notes = document.getElementById("dashNotes").value;
    saveDashState(d);
  };

  document.getElementById("btnLock").onclick = () => {
    dashSessionLock(true);
    renderPinControlsAndNotes();
  };

  document.getElementById("btnClearPin").onclick = () => {
    if (!confirm("Remove PIN protection?")) return;
    const d = loadDashState();
    d.pinHash = null;
    saveDashState(d);
    dashSessionLock(true);
    renderPinControlsAndNotes();
  };
}

/* Session unlock state (not persisted across devices; this is intentional) */
function dashSessionUnlocked(){
  return sessionStorage.getItem("dashUnlocked") === "1";
}
function dashSessionLock(lock){
  sessionStorage.setItem("dashUnlocked", lock ? "0" : "1");
}

/* =========================
   DAY VIEW RENDER
   - Layout switch implemented here: columns first, then semanal panel.
========================= */

function renderDay(dayKey){
  const app = document.getElementById("app");

  const dayState = loadDailyState();
  dayState[dayKey] = dayState[dayKey] || { checks:{}, notes:"" };

  app.innerHTML = `
    <div class="columns" id="columns"></div>

    <section class="panel" aria-label="Weekly chores">
      <h3>Semanal</h3>
      <div class="hint">Asignar y rotar manualmente. Se mantiene igual en todos los dÃ­as.</div>
      <div class="weeklyGrid" id="weeklyGrid"></div>
    </section>

    <section class="panel" aria-label="Yesterday Summary">
      <h3 id="yesterdayTitle">Ayer</h3>
      <div class="yesterdayGrid" id="yesterdayGrid"></div>
    </section>

    <section class="panel notesDay">
      <h3>Notas del dÃ­a</h3>
      <textarea id="dailyNotes" placeholder="Notas para hoy..."></textarea>
    </section>
  `;

  renderDailyColumns(dayKey);
  renderWeekly();
  renderYesterday(dayKey);
  renderDayNotes(dayKey);
}

function renderDailyColumns(dayKey){
  const columns = document.getElementById("columns");
  columns.innerHTML = "";

  const state = loadDailyState();
  state[dayKey] = state[dayKey] || { checks:{}, notes:"" };

  PEOPLE.forEach(person => {
    const col = document.createElement("div");
    col.className = "column";

    const h = document.createElement("h2");
    h.textContent = person;
    col.appendChild(h);

    (DAILY_CHORES[person] || []).forEach(chore => {
      const key = `${person}::${chore}`;
      const row = document.createElement("div");
      row.className = "chore";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state[dayKey].checks[key];
      cb.onchange = () => {
        const s = loadDailyState();
        s[dayKey] = s[dayKey] || { checks:{}, notes:"" };
        s[dayKey].checks[key] = cb.checked;
        saveDailyState(s);
      };

      const label = document.createElement("span");
      label.textContent = chore;

      row.appendChild(cb);
      row.appendChild(label);
      col.appendChild(row);
    });

    columns.appendChild(col);
  });
}

function renderDayNotes(dayKey){
  const state = loadDailyState();
  state[dayKey] = state[dayKey] || { checks:{}, notes:"" };

  const notes = document.getElementById("dailyNotes");
  notes.value = state[dayKey].notes || "";
  notes.oninput = () => {
    const s = loadDailyState();
    s[dayKey] = s[dayKey] || { checks:{}, notes:"" };
    s[dayKey].notes = notes.value;
    saveDailyState(s);
  };
}

function renderWeekly(){
  const grid = document.getElementById("weeklyGrid");
  grid.innerHTML = "";

  const w = loadWeeklyState();
  w.checks = w.checks || {};
  w.assign = w.assign || {};

  WEEKLY_CHORES.forEach(chore => {
    const row = document.createElement("div");
    row.className = "weeklyItem";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!w.checks[chore];
    cb.onchange = () => {
      const ws = loadWeeklyState();
      ws.checks = ws.checks || {};
      ws.checks[chore] = cb.checked;
      saveWeeklyState(ws);
      // update dashboard ring if open later
    };

    const label = document.createElement("div");
    label.className = "label";
    label.textContent = chore;

    const sel = document.createElement("select");
    const blank = document.createElement("option");
    blank.value = "";
    blank.textContent = "Asignarâ€¦";
    sel.appendChild(blank);

    PEOPLE.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });

    sel.value = w.assign[chore] || "";
    sel.onchange = () => {
      const ws = loadWeeklyState();
      ws.assign = ws.assign || {};
      ws.assign[chore] = sel.value;
      saveWeeklyState(ws);
    };

    row.appendChild(cb);
    row.appendChild(label);
    row.appendChild(sel);
    grid.appendChild(row);
  });

  saveWeeklyState(w);
}

function renderYesterday(dayKey){
  const y = prevDayKey(dayKey);
  const title = document.getElementById("yesterdayTitle");
  title.textContent = `Ayer (${y})`;

  const grid = document.getElementById("yesterdayGrid");
  grid.innerHTML = "";

  PEOPLE.forEach(person => {
    const card = document.createElement("div");
    card.className = "yCard";

    const t = document.createElement("div");
    t.className = "yTitle";
    t.textContent = person;
    card.appendChild(t);

    const list = DAILY_CHORES[person] || [];
    list.forEach(chore => {
      const line = document.createElement("div");
      line.className = "yLine";
      line.textContent = `${person} â€“ ${chore}`;
      card.appendChild(line);
    });

    grid.appendChild(card);
  });
}

/* =========================
   BIWEEKLY / MONTHLY / MAINTENANCE (scaffold pages)
   - These are intentionally minimal in Phase 4.
========================= */

function renderChecklistPage(kind){
  const app = document.getElementById("app");
  const isBi = kind === "biweekly";
  const title = isBi ? "Bi-weekly" : "Monthly";
  const list = isBi ? BIWEEKLY_CHORES : MONTHLY_CHORES;

  app.innerHTML = `
    <section class="panel">
      <div class="toolbar">
        <div class="left">
          <h2 style="margin:0;">${title}</h2>
          <div class="hint" style="margin:0;">Check items as you complete them. Use the reset button to clear this section only.</div>
        </div>
        <div class="right">
          <button class="danger" id="btnReset">${title} Reset</button>
        </div>
      </div>
      <div class="listGrid" id="listGrid"></div>
    </section>
  `;

  const grid = document.getElementById("listGrid");
  grid.innerHTML = "";

  if (list.length === 0){
    const empty = document.createElement("div");
    empty.className = "panel";
    empty.style.background = "transparent";
    empty.style.borderStyle = "dashed";
    empty.style.color = "rgba(245,245,245,0.7)";
    empty.textContent = "No items yet. We'll add them next phase.";
    grid.appendChild(empty);
  } else {
    const state = isBi ? loadBiweeklyState() : loadMonthlyState();
    state.checks = state.checks || {};
    state.assign = state.assign || {};

    list.forEach(item => {
      const row = document.createElement("div");
      row.className = "listItem";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state.checks[item];
      cb.onchange = () => {
        const s = isBi ? loadBiweeklyState() : loadMonthlyState();
        s.checks = s.checks || {};
        s.checks[item] = cb.checked;
        isBi ? saveBiweeklyState(s) : saveMonthlyState(s);
      };

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = item;

      
      row.appendChild(cb);
row.appendChild(name);

// Assignment dropdown (bi-weekly + monthly)
state.assign = state.assign || {};

const sel = document.createElement("select");
sel.className = "assignSelect";

const blank = document.createElement("option");
blank.value = "";
blank.textContent = "Asignarâ€¦";
sel.appendChild(blank);

PEOPLE.forEach(p => {
  const opt = document.createElement("option");
  opt.value = p;
  opt.textContent = p;
  sel.appendChild(opt);
});

sel.value = state.assign[item] || "";

sel.onchange = () => {
  const s = isBi ? loadBiweeklyState() : loadMonthlyState();
  s.assign = s.assign || {};
  s.assign[item] = sel.value;
  if (isBi) saveBiweeklyState(s);
  else saveMonthlyState(s);
};

row.appendChild(sel);

grid.appendChild(row);
    });

    isBi ? saveBiweeklyState(state) : saveMonthlyState(state);
  }

  document.getElementById("btnReset").onclick = () => {
    if (!confirm(`Reset ${title} items?`)) return;
    localStorage.removeItem(isBi ? "biweeklyState" : "monthlyState");
    renderChecklistPage(kind);
  };
}

function renderMaintenance(){
  const app = document.getElementById("app");
  const s = loadMaintState();
  s.entries = s.entries || [];

// Phase 7.1: migrate legacy entries (no id) so delete works reliably
  let changed = false;
  s.entries = s.entries.map(e => {
    if (!e || typeof e !== "object") return e;
    if (!e.id) {
      changed = true;
      return { ...e, id: makeId() };
    }
    return e;
  });
  if (changed) saveMaintState(s);

  // Sort newest first (by date, then by insertion order)
  const entries = [...s.entries].sort((a, b) => {
    const da = (a.date || "");
    const db = (b.date || "");
    if (da === db) return 0;
    return da < db ? 1 : -1;
  });

  // Build options for completedBy
  const peopleOpts = PEOPLE.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");

  // Simple suggested tasks (you can type anything)
  const suggestions = [
    "Change AC filter",
    "AC Flush",
    "Pool Filter clean/change"
  ];

  const suggestionOptions = suggestions
    .map(t => `<option value="${escapeHtml(t)}"></option>`)
    .join("");

  app.innerHTML = `
    <section class="panel">
      <div class="toolbar">
        <div class="left">
          <h2 style="margin:0;">House Maintenance</h2>
          <div class="hint" style="margin:0;">Log entries with task, completed by, and date. Stored locally on this device.</div>
        </div>
        <div class="right">
          <button class="danger" id="btnResetMaint">Maintenance Reset</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="hint" style="margin-top:0;">Add a new entry</div>

        <div class="maintForm">
          <div class="field">
            <label>Task</label>
            <input id="maintTask" list="maintTaskSuggestions" placeholder="Type a task (or pick a suggestion)..." />
            <datalist id="maintTaskSuggestions">
              ${suggestionOptions}
            </datalist>
          </div>

          <div class="field">
            <label>Completed by</label>
            <select id="maintBy">
              <option value="">Selectâ€¦</option>
              ${peopleOpts}
            </select>
          </div>

          <div class="field">
            <label>Date</label>
            <input id="maintDate" type="date" />
          </div>

          <div class="field actions">
            <label>&nbsp;</label>
            <button id="btnAddMaint">Add entry</button>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="toolbar" style="margin-bottom:8px;">
          <div class="left">
            <div class="hint" style="margin:0;">History</div>
          </div>
          <div class="right">
            <div class="hint" style="margin:0;">${entries.length} entr${entries.length === 1 ? "y" : "ies"}</div>
          </div>
        </div>

        <div id="maintEmpty" class="panel" style="display:${entries.length ? "none" : "block"};background:transparent;border-style:dashed;color:rgba(245,245,245,0.7);">
          No maintenance entries yet. Which is either amazing or terrifying.
        </div>

        <div class="maintList" id="maintList"></div>
      </div>
    </section>
  `;

  // Default the date to today (Option A you picked earlier)
  const dateEl = document.getElementById("maintDate");
  dateEl.value = isoToday();

  // Render list
  const list = document.getElementById("maintList");
  list.innerHTML = entries.map((e, idx) => {
    const task = escapeHtml(e.task || "");
    const by = escapeHtml(e.by || "");
    const date = escapeHtml(e.date || "");

    return `
      <div class="maintRow">
        <div class="maintMeta">
          <div class="maintTask">${task || "(No task)"}</div>
          <div class="maintSub">${by || "(No person)"} â€¢ ${date || "(No date)"}</div>
        </div>
        <div class="maintActions">
          <button class="ghost" data-id="${escapeHtml(e.id || "")}" title="Delete entry">Delete</button>
        </div>
      </div>
    `;
  }).join("");

  // Delete handlers (by index in the sorted list, so we match by value)
  list.querySelectorAll("[data-id]").forEach(btn => {
  btn.onclick = () => {
    const id = (btn.getAttribute("data-id") || "").trim();
    if (!id) return;

    if (!confirm("Delete this maintenance entry?")) return;

    const current = loadMaintState();
    current.entries = (current.entries || []).filter(e => e.id !== id);
    saveMaintState(current);
    renderMaintenance();
  };
});

  // Add entry handler
  document.getElementById("btnAddMaint").onclick = () => {
    const task = (document.getElementById("maintTask").value || "").trim();
    const by = (document.getElementById("maintBy").value || "").trim();
    const date = (document.getElementById("maintDate").value || "").trim();

    if (!task) { alert("Task is required."); return; }
    if (!by) { alert("Completed by is required."); return; }
    if (!date) { alert("Date is required."); return; }

    const current = loadMaintState();
    current.entries = current.entries || [];
    current.entries.push({ id: makeId(), task, by, date });
    saveMaintState(current);

    renderMaintenance();
  };

  // Reset button (kept)
  document.getElementById("btnResetMaint").onclick = () => {
    if (!confirm("Reset maintenance log?")) return;
    localStorage.removeItem("maintState");
    renderMaintenance();
  };
}

/* =========================
   WEEKLY RESET (per your rules)
   - resets daily pages (checkboxes + notes)
   - resets weekly chores (checks + assignments)
   - DOES NOT touch dashboard notes/pin
   - DOES NOT touch biweekly/monthly/maintenance
========================= */

function weeklyReset(){
  if (!confirm("Weekly Reset: clear daily checkboxes + daily notes + weekly chores assignments/checks?")) return;
  localStorage.removeItem("dailyState");
  localStorage.removeItem("weeklyState");
  // stay on current page, re-render
  renderApp();
}

/* =========================
   APP RENDER
========================= */

function renderApp(){
  renderTopNav();
  const r = route();
  console.log("HASH:", location.hash, "ROUTE:", r);

  // add a contextual reset button to top nav only when on a day page
  // (keeps screen real estate used but avoids clutter on dashboard)
  addContextResetButton(r);

  if (r === "dashboard") return renderDashboard();
  if (r === "biweekly") return renderChecklistPage("biweekly");
  if (r === "monthly") return renderChecklistPage("monthly");
  if (r === "maintenance") return renderMaintenance();

  // day route
  if (DAYS.includes(r)) return renderDay(r);

  // special alias: "hoy" means today's day page
  if (r === "hoy") return renderDay(todayKey());

  // unknown route: go home instead of silently showing today
  return goto("dashboard");
}

function addContextResetButton(r){
  // Remove any existing context buttons first (id-based)
  const nav = document.getElementById("topNav");
  const existing = document.getElementById("ctxReset");
  if (existing) existing.remove();

  if (DAYS.includes(r)){
    const btn = document.createElement("button");
    btn.id = "ctxReset";
    btn.className = "danger";
    btn.textContent = "Weekly Reset";
    btn.onclick = weeklyReset;
    nav.appendChild(btn);
  }
}

/* =========================
   UTIL
========================= */

function escapeHtml(str){
  return (str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function isoToday(){
  // Returns YYYY-MM-DD in local time
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}
function makeId(){
  // Prefer native UUID; fall back for older Safari just in case
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  return `id_${Date.now()}_${Math.random().toString(16).slice(2)}`;
}


/* =========================
   INIT
========================= */

// Default to dashboard if no hash
if (!location.hash){
  goto("dashboard");
} else {
  renderApp();
}

/* =========================
   SERVICE WORKER
========================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>
</body>
</html>
